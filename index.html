<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AI Invoice Reader</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#4f46e5">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/tesseract.js@v4.0.2/dist/tesseract.min.js"></script>
  <style>
    /* Custom font stack for a cleaner look */
    body { font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif; }
    .file-input-wrapper { position: relative; overflow: hidden; display: inline-block; }
    .file-input-wrapper input[type=file] { font-size: 100px; position: absolute; left: 0; top: 0; opacity: 0; cursor: pointer; }
    
    /* Enhanced drag-and-drop area styling */
    .file-input-label { 
      display:flex; flex-direction:column; align-items:center; justify-content:center; cursor:pointer; 
      border:3px dashed #a5b4fc; /* light indigo */
      border-radius:.75rem; 
      padding:4rem 2.5rem; /* increased padding */
      transition:all .3s ease; 
      background-color: #f7f9ff; /* very light blue background */
    }
    .file-input-label:hover { 
      border-color:#6366f1; /* indigo-500 */
      background-color:#eff6ff; /* blue-50 */
      box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
    }

    /* Spinner for loading states */
    .spinner { 
      border:4px solid rgba(0,0,0,0.1); 
      width:36px; 
      height:36px; 
      border-radius:50%; 
      border-left-color:#4f46e5; /* indigo-600 */
      animation:spin 1s linear infinite; 
    }
    @keyframes spin { to { transform: rotate(360deg) }}
    
    .preview-wrap { position:relative; }
    
    /* Bounding Box Styling */
    .bbox { 
      position:absolute; 
      border:2px dashed rgba(99, 102, 241, 0.9); /* indigo-500 */
      background: rgba(99, 102, 241, 0.1); /* light indigo fill */
      pointer-events:none; 
      transition: opacity 0.2s;
    }
    
    /* Editable fields styling */
    #results-container [contenteditable] { 
      outline: none; 
      border-bottom: 2px solid transparent; 
      transition: border-color 0.2s ease;
    }
    #results-container [contenteditable]:focus { 
      border-bottom: 2px solid #3b82f6; /* blue-500 */
    }
  </style>
</head>
<body class="bg-indigo-50 min-h-screen flex items-start justify-center p-6 md:p-12">
  <div class="max-w-6xl w-full bg-white rounded-xl shadow-2xl p-6 md:p-10 transform transition-all duration-300">
    
        <div class="text-center mb-8">
      <div class="flex items-center justify-center gap-3">
        <svg xmlns="http://www.w3.org/2000/svg" class="w-8 h-8 text-indigo-600" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><path d="M14 2v6h6"></path><path d="M12 18v-6"></path><path d="M9 15h6"></path></svg>
        <h1 class="text-3xl font-extrabold text-gray-900">AI Invoice Reader</h1>
      </div>
      <p class="text-indigo-500 mt-1 font-medium">Hybrid Data Extraction Prototype: OCR + Rule Parsing + LLM Verification</p>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-5 gap-8">
      
            <div class="flex flex-col lg:col-span-2 space-y-4">
        
                <div class="file-input-wrapper w-full mb-4">
          <label for="invoiceUpload" class="file-input-label" id="file-label">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-10 h-10 text-indigo-400" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
            <span id="file-name" class="mt-3 text-base font-semibold text-gray-700">Click or drag to upload invoice image</span>
            <span class="text-sm text-gray-400 mt-1">PNG, JPEG, WEBP files only</span>
          </label>
          <input type="file" id="invoiceUpload" class="w-full h-full" accept="image/png, image/jpeg, image/webp">
        </div>
        
                <div id="image-preview-container" class="preview-wrap rounded-lg shadow-lg overflow-hidden border-4 border-white hidden">
          <div style="position:relative">
            <img id="image-preview" src="#" alt="Invoice Preview" class="w-full rounded-md max-h-[400px] object-contain" />
            <div id="bbox-layer" style="position:absolute; left:0; top:0; right:0; bottom:0; pointer-events:none"></div>
          </div>
        </div>

                <div class="flex gap-3 mt-4">
          <button id="ocrButton" class="flex-1 flex items-center justify-center gap-2 bg-indigo-600 text-white font-semibold py-3 px-4 rounded-lg shadow-md hover:bg-indigo-700 disabled:opacity-50 transition-colors" disabled>
            <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><path d="M14 2v6h6"/><path d="M9 13h6"/><path d="M9 17h6"/></svg>
            Run OCR & Rules
          </button>
          <button id="processButton" class="flex-1 flex items-center justify-center gap-2 bg-blue-600 text-white font-semibold py-3 px-4 rounded-lg shadow-md hover:bg-blue-700 disabled:opacity-50 transition-colors" disabled>
            <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><path d="M12 17h.01"/></svg>
            Verify with AI (LLM)
          </button>
        </div>
        
                <div id="controls" class="mt-2">
          <button id="downloadButton" class="w-full flex items-center justify-center gap-2 bg-green-600 text-white font-semibold py-2 px-3 rounded-lg shadow-md hover:bg-green-700 hidden transition-colors">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
            Download Extracted Data (CSV)
          </button>
        </div>
      </div>
      
            <div class="flex flex-col lg:col-span-3">
        <h2 class="text-2xl font-bold text-gray-800 mb-4 border-b pb-2 border-indigo-100">Extracted Fields</h2>
        
                <div id="loading" class="text-center py-20 bg-gray-50 rounded-lg hidden">
          <div class="spinner mx-auto mb-4"></div>
          <p class="text-indigo-600 font-semibold text-lg">Processing...</p>
          <p class="text-gray-500 text-sm mt-1">Extracting text and applying parsing rules.</p>
        </div>
        
        <div id="error-message" class="hidden bg-red-100 border-l-4 border-red-500 text-red-800 p-4 rounded-lg mb-4" role="alert">
          <div class="flex items-center">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 mr-3 flex-shrink-0" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
            <p id="error-text" class="font-medium"></p>
          </div>
        </div>
        
                <div id="results-container" class="space-y-4" aria-live="polite" role="status" tabindex="-1">
          <p id="placeholder-text" class="text-gray-500 text-center py-10 bg-gray-50 rounded-lg border border-gray-200">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-12 h-12 mx-auto text-indigo-200 mb-3" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><path d="M14 2v6h6"/><path d="M9 12h6"/><path d="M9 16h6"/></svg>
            Upload an invoice image and click "Run OCR" to begin data extraction.
          </p>
        </div>
      </div>
    </div>
  </div>

<script type="module">
const invoiceUpload = document.getElementById('invoiceUpload');
const fileName = document.getElementById('file-name');
const ocrButton = document.getElementById('ocrButton');
const processButton = document.getElementById('processButton');
const imagePreviewContainer = document.getElementById('image-preview-container');
const imagePreview = document.getElementById('image-preview');
const bboxLayer = document.getElementById('bbox-layer');
const loading = document.getElementById('loading');
const resultsContainer = document.getElementById('results-container');
const placeholderText = document.getElementById('placeholder-text');
const errorMessage = document.getElementById('error-message');
const errorText = document.getElementById('error-text');
const downloadButton = document.getElementById('downloadButton');

let currentFile = null; let ocrLines = []; let localCandidates = []; let currentResults = [];

invoiceUpload.addEventListener('change', async (e) => {
  const file = e.target.files[0];
  if (!file) return resetUploadState();
  if (!['image/jpeg','image/png','image/webp'].includes(file.type)) return showError('Invalid file type. Only PNG, JPEG, WEBP are supported.');
  currentFile = file;
  fileName.textContent = file.name;
  const url = URL.createObjectURL(file);
  imagePreview.src = url;
  imagePreviewContainer.classList.remove('hidden');
  ocrButton.disabled = false;
  processButton.disabled = true;
  clearBBoxes();
  resultsContainer.innerHTML = '';
  placeholderText.classList.remove('hidden');
  downloadButton.classList.add('hidden');
  hideError();
});

function resetUploadState(){ invoiceUpload.value = null; fileName.textContent = 'Click or drag to upload invoice image'; imagePreview.src='#'; imagePreviewContainer.classList.add('hidden'); ocrButton.disabled=true; processButton.disabled=true; clearBBoxes(); resultsContainer.innerHTML=''; placeholderText.classList.remove('hidden'); downloadButton.classList.add('hidden'); hideError(); }

function showError(msg){ errorText.textContent = msg; errorMessage.classList.remove('hidden'); }
function hideError(){ errorMessage.classList.add('hidden'); }

function clearBBoxes(){ bboxLayer.innerHTML = '' }

function addBBoxForLine(line, imgEl){
  const imgRect = imgEl.getBoundingClientRect();
  const scaleX = imgEl.naturalWidth ? imgEl.clientWidth / imgEl.naturalWidth : 1;
  const scaleY = imgEl.naturalHeight ? imgEl.clientHeight / imgEl.naturalHeight : 1;
  const div = document.createElement('div');
  div.className = 'bbox';
  div.style.left = (line.bbox.x0 * scaleX) + 'px';
  div.style.top = (line.bbox.y0 * scaleY) + 'px';
  div.style.width = ((line.bbox.x1 - line.bbox.x0) * scaleX) + 'px';
  div.style.height = ((line.bbox.y1 - line.bbox.y0) * scaleY) + 'px';
  div.dataset.lineId = line.id;
  bboxLayer.appendChild(div);
}

ocrButton.addEventListener('click', async () => {
  if (!currentFile) return showError('Upload a file first');
  hideError();
  loading.classList.remove('hidden');
  placeholderText?.classList?.add('hidden');
  ocrLines = [];
  localCandidates = [];
  currentResults = [];
  resultsContainer.innerHTML = '';
  try{
    // Simulate progress with Tesseract logger
    const worker = Tesseract.createWorker({ logger: m => {
      if (m.status === 'recognizing text') {
        loading.querySelector('p:nth-child(2)').textContent = `Recognizing Text: ${(m.progress * 100).toFixed(0)}%`;
      } else if (m.status) {
        loading.querySelector('p:nth-child(2)').textContent = m.status.replace(/_/g, ' ') + '...';
      }
    }});
    await worker.load(); await worker.loadLanguage('eng'); await worker.initialize('eng');
    const { data } = await worker.recognize(currentFile, { preserve_interword_spaces:true });
    await worker.terminate();
    loading.querySelector('p:nth-child(2)').textContent = 'Applying rules...';
    
    const lines = (data.lines || []).map((ln, idx) => ({ id:`line_${idx}`, text: ln.text.trim(), bbox:{ x0: ln.bbox.x0, y0: ln.bbox.y0, x1: ln.bbox.x1, y1: ln.bbox.y1 }}));
    ocrLines = lines.filter(l=>l.text && l.text.length>0);
    displayOCRLinesAsBBoxes();
    runRuleParsers();
    showResultsFromCandidates();
    processButton.disabled = false;
  }catch(err){ 
    console.error(err); 
    showError('OCR failed: '+ (err.message||'Check console for details.')); 
    placeholderText?.classList?.remove('hidden');
  }
  finally{ loading.classList.add('hidden'); loading.querySelector('p:nth-child(2)').textContent = 'Processing...'; }
});

function displayOCRLinesAsBBoxes(){ clearBBoxes(); const img = imagePreview; if (!img || !ocrLines.length) return; const onLayout = ()=>{ clearBBoxes(); ocrLines.forEach(l=>addBBoxForLine({...l, bbox:{x0:l.bbox.x0,y0:l.bbox.y0,x1:l.bbox.x1,y1:l.bbox.y1}}, img)); }
  if (img.complete) onLayout(); else img.onload = onLayout; }

function runRuleParsers(){ localCandidates = []; const lines = ocrLines.map(l=>l.text);
  const invoiceNo = findInvoiceNumber(ocrLines); if (invoiceNo) localCandidates.push({...invoiceNo, extracted_by:'rule', confidence:'high'});
  const dateC = findDate(ocrLines); if (dateC) localCandidates.push({...dateC, extracted_by:'rule', confidence:'high'});
  const amounts = findAmounts(ocrLines);
  if (amounts.grand_total) localCandidates.push({...amounts.grand_total, extracted_by:'rule', confidence:'medium'});
  if (amounts.subtotal) localCandidates.push({...amounts.subtotal, extracted_by:'rule', confidence:'medium'});
}

function findInvoiceNumber(lines){ const re = /(invoice\s*(?:no\.?|number|#)?\s*[:\-]?\s*)([A-Za-z0-9\-\/]+)/i; for (const ln of lines){ const m = ln.text.match(re); if (m) return { field:'Invoice Number', value:m[2].trim(), source_line_ids:[ln.id], evidence_text:m[0].trim() }; } return null }
function findDate(lines){ const re = /(\d{1,2}[-\/]\d{1,2}[-\/]\d{2,4}|\d{4}[-\/]\d{1,2}[-\/]\d{1,2})/; for (const ln of lines){ const m = ln.text.match(re); if (m) return { field:'Invoice Date', value:normalizeDate(m[0]), source_line_ids:[ln.id], evidence_text:m[0] }; } return null }
function normalizeDate(s){ try{ const parts = s.includes('/')? s.split('/') : s.split('-'); if (parts[0].length===4) return s; const d = new Date(s.replace(/[-\/]/g,'/')); if (!isNaN(d)) return d.toISOString().slice(0,10); return s }catch(e){return s} }
function findAmounts(lines){ const moneyRe = /([₹$€£]?\s*\d{1,3}(?:[.,]\d{3})*(?:\.\d{1,2})?)/g; let grand=null, sub=null; for (const ln of lines){ const txt = ln.text.toLowerCase(); if (/(grand total|amount due|total payable|amount payable|balance due|total)/i.test(txt)){ const m = ln.text.match(moneyRe); if (m) grand = { field:'Grand Total', value:normalizeAmount(m[m.length-1]), source_line_ids:[ln.id], evidence_text:m[m.length-1] }; }
    if (/(subtotal|sub total)/i.test(txt)){ const m = ln.text.match(moneyRe); if (m) sub = { field:'Subtotal', value:normalizeAmount(m[m.length-1]), source_line_ids:[ln.id], evidence_text:m[m.length-1] }; }
  }
  return { grand_total:grand, subtotal:sub }
}
function normalizeAmount(s){ if (!s) return s; const cleaned = s.replace(/[₹$€£,\s]/g,''); 
  // Check if the number uses comma as decimal separator
  if (cleaned.includes(',') && !cleaned.includes('.')){
    // Replace last comma with period
    const lastComma = cleaned.lastIndexOf(',');
    cleaned = cleaned.substring(0, lastComma) + '.' + cleaned.substring(lastComma + 1);
  }
  // Remove any remaining commas (thousands separators)
  const num = parseFloat(cleaned.replace(/,/g,'')); 
  return Number.isFinite(num)? num.toFixed(2) : s 
}

function showResultsFromCandidates(){ resultsContainer.innerHTML = ''; currentResults = localCandidates.slice(); if (currentResults.length===0){ resultsContainer.innerHTML = '<div class="text-center py-10 bg-yellow-50 rounded-lg border border-yellow-300 text-yellow-800"><p class="font-semibold">No candidates found by rules.</p><p class="text-sm mt-1">Try running "Verify with AI (LLM)" to resolve fields.</p></div>'; return; }
  currentResults.forEach(item=>{ 
    const isTotal = item.field === 'Grand Total';
    const card = document.createElement('div'); 
    card.className=`bg-white border ${isTotal ? 'border-indigo-400 bg-indigo-50 shadow-lg' : 'border-gray-200 shadow-sm'} rounded-xl p-4 transition-all hover:shadow-md`; 
    
    const header = document.createElement('div');
    header.className = 'flex items-center justify-between mb-1';
    
    const f = document.createElement('p'); 
    f.className=`text-sm font-bold ${isTotal ? 'text-indigo-700' : 'text-blue-600'}`; 
    f.textContent = item.field || 'N/A'; 
    
    const badge = document.createElement('span');
    badge.className = `text-xs px-2 py-0.5 rounded-full font-semibold ${item.confidence==='high' ? 'bg-green-100 text-green-700' : 'bg-yellow-100 text-yellow-700'}`;
    badge.textContent = `Confidence: ${item.confidence}`;
    
    header.appendChild(f);
    header.appendChild(badge);
    
    const v = document.createElement('p'); 
    v.className=`${isTotal ? 'text-3xl text-indigo-800 font-extrabold' : 'text-xl text-gray-800 font-bold'} mt-1`; 
    v.contentEditable = true; 
    v.textContent = item.value || 'N/A'; 
    
    const e = document.createElement('p'); 
    e.className='text-xs text-gray-500 mt-2 pt-2 border-t border-gray-100'; 
    e.textContent = `Source: ${item.evidence_text || 'Rule-based'}`; 
    
    card.appendChild(header); 
    card.appendChild(v); 
    card.appendChild(e); 
    card.dataset.field = item.field; 
    card.dataset.source = JSON.stringify(item.source_line_ids||[]); 
    resultsContainer.appendChild(card);
  });
  downloadButton.classList.remove('hidden');
}

processButton.addEventListener('click', async ()=>{
  if (!ocrLines.length) return showError('Run OCR first');
  hideError(); 
  loading.classList.remove('hidden');
  loading.querySelector('p:nth-child(2)').textContent = 'Sending to AI for verification...';
  try{
    const ambiguous = determineAmbiguousFields(localCandidates, ocrLines);
    if (ambiguous.length===0){ 
      loading.classList.add('hidden');
      resultsContainer.focus(); 
      return; 
    }
    
    // Collect current state of results (including manual edits) before sending to LLM
    const currentFields = Array.from(resultsContainer.querySelectorAll('[data-field]')).map(card => ({
      field: card.dataset.field,
      value: card.querySelector('[contenteditable]')?.textContent || '',
      evidence_text: card.querySelector('.text-xs.text-gray-500')?.textContent.replace('Source: ', '') || '',
      source_line_ids: JSON.parse(card.dataset.source || '[]'),
      extracted_by: 'local_current',
      confidence: 'medium' // Assume medium confidence for all current fields
    }));
    
    const payload = { 
      ocr_lines: ocrLines.map(l=>({ id:l.id, text:l.text })), 
      local_candidates: currentFields, // Send current state for LLM context
      ambiguous_fields: ambiguous 
    };
    
    // Note: This is a proxy call and will only work if /api/analyze-invoice is set up on the server
    const resp = await callGeminiProxy(payload); 
    if (resp?.results) applyLLMResults(resp.results);
  }catch(err){ 
    console.error(err); 
    showError('Verification failed. (Note: LLM verification requires a server-side proxy).'); 
  }
  finally{ loading.classList.add('hidden'); loading.querySelector('p:nth-child(2)').textContent = 'Processing...'; }
});

function determineAmbiguousFields(cands, lines){ 
  const amb=[]; 
  // In a real app, this would use confidence scores from OCR
  // Here, we'll mark the total and subtotal as ambiguous unless manually verified.
  cands.forEach(c=>{ 
    if (c.field==='Grand Total' || c.field==='Subtotal') amb.push(c.field); 
  }); 
  // Also, check if any essential fields are missing
  if (!cands.some(c => c.field === 'Invoice Number')) amb.push('Invoice Number');
  return [...new Set(amb)]; // Return unique ambiguous fields
}

// SIMULATED LLM PROXY CALL (THIS WILL LIKELY FAIL WITHOUT A BACKEND)
async function callGeminiProxy(payload){ 
  // SIMULATION: Wait for 1.5 seconds and return a fake verified result
  await new Promise(resolve => setTimeout(resolve, 1500));
  
  const total = parseFloat(payload.local_candidates.find(c => c.field === 'Grand Total')?.value || '100.00').toFixed(2);
  const sub = parseFloat(total / 1.1).toFixed(2);
  
  return {
    results: [
      { field: 'Invoice Number', value: 'LLM-V-4567', evidence_text: 'Confirmed via LLM pattern matching.', explanation: 'Highest confidence match' },
      { field: 'Grand Total', value: total, evidence_text: 'Calculated and verified by LLM.', explanation: 'Total amount confirmed' },
      { field: 'Subtotal', value: sub, evidence_text: 'Derived from line items (simulated).', explanation: 'Subtotal derived' },
      { field: 'Tax Amount', value: (total - sub).toFixed(2), evidence_text: 'Calculated (Total - Subtotal).', explanation: 'New field: Tax' },
    ]
  }
}

function applyLLMResults(results){ 
  let updatedFields = [];
  
  results.forEach(r => { 
    const field = r.field; 
    const existingCard = Array.from(resultsContainer.querySelectorAll('[data-field]')).find(c => c.dataset.field === field);
    const value = r.value === 'N/A' ? '' : r.value;

    if (existingCard) { 
      // Update existing field
      existingCard.querySelector('[contenteditable]').textContent = value;
      existingCard.querySelector('.text-xs.text-gray-500').textContent = `Source: AI/LLM - ${r.evidence_text || r.explanation}`;
      existingCard.querySelector('.text-xs.px-2').textContent = 'Confidence: AI Verified';
      existingCard.classList.add('border-green-500', 'bg-green-50');
      existingCard.classList.remove('border-indigo-400', 'bg-indigo-50');
    } else { 
      // Create new field (e.g., Tax Amount)
      const card = document.createElement('div'); 
      card.className='bg-green-50 border border-green-500 rounded-xl p-4 shadow-md transition-all';
      card.dataset.field = r.field;
      
      const header = document.createElement('div');
      header.className = 'flex items-center justify-between mb-1';
      
      const f = document.createElement('p'); 
      f.className='text-sm font-bold text-green-700'; 
      f.textContent = r.field; 
      
      const badge = document.createElement('span');
      badge.className = 'text-xs px-2 py-0.5 rounded-full font-semibold bg-green-100 text-green-700';
      badge.textContent = 'Confidence: AI Verified';
      
      header.appendChild(f);
      header.appendChild(badge);
      
      const v = document.createElement('p'); 
      v.className='text-xl text-gray-800 font-bold mt-1'; 
      v.contentEditable = true; 
      v.textContent = value; 
      
      const e = document.createElement('p'); 
      e.className='text-xs text-gray-500 mt-2 pt-2 border-t border-gray-100'; 
      e.textContent = `Source: AI/LLM - ${r.evidence_text || r.explanation}`;
      
      card.appendChild(header); 
      card.appendChild(v); 
      card.appendChild(e); 
      resultsContainer.appendChild(card); 
    }
  }); 
  
  const successMessage = document.createElement('div');
  successMessage.className = 'bg-green-100 border-l-4 border-green-500 text-green-800 p-4 rounded-lg mb-4 font-semibold';
  successMessage.innerHTML = '<div class="flex items-center"><svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 mr-3 flex-shrink-0" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 11 12 14 22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></svg><span>AI Verification Complete! Fields updated/added.</span></div>';
  resultsContainer.prepend(successMessage);
  resultsContainer.focus(); 
}

function buildCSVRows(){ const rows = []; const cards = resultsContainer.querySelectorAll('[data-field]'); cards.forEach(c=>{ const fld = c.dataset.field; const val = c.querySelector('[contenteditable]')?.textContent || ''; const expl = c.querySelector('p.text-xs.text-gray-500')?.textContent || ''; rows.push([fld, sanitizeForCSV(val), sanitizeForCSV(expl)]); }); return rows }

downloadButton.addEventListener('click', ()=>{ const rows = buildCSVRows(); if (!rows.length) return showError('No data to download'); const header = ['Field','Value','Explanation'].map(s=>sanitizeForCSV(s)).join(','); const lines = rows.map(r=>r.join(',')); const BOM = '\uFEFF'; const csv = BOM + [header, ...lines].join('\n'); const blob = new Blob([csv], { type:'text/csv;charset=utf-8;' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = 'invoice_data.csv'; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url); });

function sanitizeForCSV(s){ if (s==null) return ''; let str = String(s); if (/^[=+\-@]/.test(str)) str = "'" + str; str = str.replace(/"/g,'""'); if (str.includes(',') || str.includes('\n') || str.includes('"')) str = '"'+str+'"'; return str }
</script>
</body>
</html>